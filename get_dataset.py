import os
import pathlib
import csv
import re
import solcx

pattern = "[!\"#$%&'()*+,\-/:;<=>?@[\]^_`{|}~]"
field_names = ["opcode","vulnerability"]
data = []

def find_solidity_version(Lines):
   for line in Lines:
      splitted = line.split(" ")
      if "pragma" in splitted :
         return splitted[2]

def get_file_extension(file_name):
    file_extension = pathlib.Path(file_name).suffix
    return file_extension

for folder_name in os.listdir("SolidiFI-benchmark/buggy_contracts"):
    print(folder_name + ": ")
    for file in os.listdir(os.path.join("SolidiFI-benchmark/buggy_contracts", folder_name)):
        if get_file_extension(file) == ".sol" :
            with open(os.path.join(os.path.join("SolidiFI-benchmark/buggy_contracts", folder_name), file), 'r') as f:
                Lines = f.readlines()
                sv = find_solidity_version(Lines)
                version = re.sub(pattern,"",sv)
                try:
                    solcx.install_solc(version)
                    out = solcx.compile_files(os.path.join(os.path.join("SolidiFI-benchmark/buggy_contracts", folder_name), file), output_values=["opcodes"],solc_version=version)
                    #print(out)
                    print(f"Success {folder_name} {file} {version}")
                    for k,v in out.items():
                        #contracts.append(v["opcodes"])
                        data.append({"opcode":v["opcodes"],"vulnerability":folder_name})
                except:
                    print(f"Error occured at {folder_name} {file} {version}")


with open('contracts.csv', 'w') as csvfile:
    writer = csv.DictWriter(csvfile, fieldnames = field_names)
    writer.writeheader()
    writer.writerows(data)